name: Build and Release SimpleDoubleClickFix (C++)

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (e.g., v1.0.0)
  workflow_dispatch: # Allows manual triggering

permissions:
  contents: write # Required to create releases and upload assets

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      # fetch-depth: 1 (default) is usually fine. If full history is needed for versioning, set to 0.

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      # This action sets up the MSBuild environment.
      # msbuild-architecture defaults to x64 on x64 runners, which is suitable for Platform=x64.

    - name: Build C++ Project
      run: msbuild SimpleDoubleClickFix\SimpleDoubleClickFix.vcxproj /p:Configuration=Release /p:Platform=x64
      shell: pwsh

    - name: Stage Binaries
      run: |
        mkdir staging
        Copy-Item -Path SimpleDoubleClickFix\x64\Release\SimpleDoubleClickFix.exe -Destination staging\
      shell: pwsh

    - name: Create ZIP Archive
      run: Compress-Archive -Path staging\* -DestinationPath SimpleDoubleClickFix.zip
      shell: pwsh

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: SimpleDoubleClickFix-${{ github.ref_name }} # Artifact name, e.g., SimpleDoubleClickFix-v1.0.0 or SimpleDoubleClickFix-master
        path: ./SimpleDoubleClickFix.zip # Path to the file to upload
        retention-days: 7 # Optional: how long to keep the artifact (max 90 for public, custom for private/enterprise)

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        # Corrected: Use github.ref_name for the tag_name.
        # For a tag push like 'refs/tags/v1.2.3', github.ref_name is 'v1.2.3'.
        # For a workflow_dispatch on 'master' branch, github.ref_name is 'master'.
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          Release notes for SimpleDoubleClickFix.

          Download the `SimpleDoubleClickFix.zip` file, extract it, and launch `SimpleDoubleClickFix.exe`.
          This will open a console window; the fix is active as long as this window remains open.
          The program prints active thresholds (e.g., for Left Mouse Button) to the console on startup.
          To stop the program, close the console window or press Ctrl+C in it.

          Windows only. This is a native C++ application and does not require a .NET runtime.
          It may require the Microsoft Visual C++ Redistributable for Visual Studio 2015-2022.
          If needed, you can usually download it from Microsoft's official website.
        draft: false
        prerelease: false # You can make this dynamic, e.g., based on whether the tag is a pre-release (contains '-')
                         # or if triggered by workflow_dispatch on a non-version branch:
                         # prerelease: ${{ (github.event_name == 'workflow_dispatch' && !startsWith(github.ref_name, 'v')) || contains(github.ref_name, '-') }}


    - name: Upload Release Asset
      # This step uploads the ZIP file to the GitHub Release created above.
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./SimpleDoubleClickFix.zip
        asset_name: SimpleDoubleClickFix.zip
        asset_content_type: application/zip